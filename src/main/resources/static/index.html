<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Mutsa-SNS</title>
    <link href="css/common.css" rel="stylesheet" type="text/css" />
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

</head>
<body>
<!-- navigation -->
<nav>
    <div class="nav-container">
        <div class="nav-1">
<!--            <img class="logo_instagram_txt" src="img/logo_text.png" alt="logo_text">-->
            <h4>Mutsa-SNS</h4>
        </div>
        <input id="searchInput" type="search" class="input-search" placeholder="검색">
        <input id="login-id" type="text" class="input-search" placeholder="아이디">
        <input id="login-pw" type="password" class="input-search" placeholder="비밀번호">
        <button id="btn-login" class="submit-login" type="submit" onclick="login()">login</button>
        <button id="btn-logout" class="submit-login hidden" type="submit" onclick="logout()" style="color: maroon">logout</button>


        <div class="nav-2">
            <img src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/explore.png" alt="탐색">
            <img src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/heart.png" alt="하트">
            <a href="/oauth2/authorization/google"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSK5q0FP74VV9wbfwP378_7kj7iDomHuKrxkXsxDdUT28V9dlVMNUe-EMzaLwaFhneeuZI&usqp=CAU" alt="구글"></a>
            <a href="/oauth2/authorization/naver"><img src="https://blog.kakaocdn.net/dn/czMTX6/btqNbvGUwIu/xxqSeZd4eRMvTHqbfIZUd0/img.png" alt="네이버"></a>
            <span class="point-span">My</span>
        </div>
    </div>
</nav>
<!-- main -->
<main>
    <div class="feeds" id="feeds-box">
        <form class="post-form">
            <header>
                <input name="title" id="post-title-input" class="post-inp" type="text" placeholder="제목을 입력하세요.">
                <span class="userID main-id point-span" id="author-username">dlwlrma</span>
            </header>
            <div class="article-main">
<!--                <label for="post-body-input"></label>-->
                <textarea name="content" id="post-body-input" class="post-inp" placeholder="내용을 입력하세요."></textarea>
            </div>
            <button class="btn-write" type="submit" onclick="writePost()">글쓰기</button>
        </form>
        <!-- article -->
        <article class="hidden">
            <header>
                <div class="profile-of-article">
                    <span class="userID point-span-title">[SpringBoot] 스프링부트 Ajax를 이용한 비동기 통신</span>
                    <span class="userID main-id point-span">dlwlrma</span>
                </div>
                <img class="icon-react icon-more" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/more.png" alt="more">
            </header>
            <div class="article-main">
                <div class="artice-body">
                    @ResponseBody 어노테이션을 반드시 붙여줍니다.
                    파라미터 String info는 json형태의 스트링입니다.
                    스트링 info를 Gson fromJson()을 이용하여 Map을 만들고 서비스 메소드를 이용하여 쿼리 결과를 가져옵니다.
                    쿼리 결과(HashMap을 원소로 갖는 List = List<HashMap<Object, Object>> selectList)를
                    Gson toJson()을 이용하여 json형태의 스트링으로 다시 변환합니다.
                    그리고 이것을 리턴합니다.
                </div>
            </div>
            <div class="icons-react">
            </div>
            <!-- article text data -->
            <div class="reaction">
                <div class="liked-people">
                    <img class="icon-react" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/heart.png" alt="하트">
                    <p><span class="point-bold">751명</span>이 좋아합니다</p>
                </div>
                <div class="comment-section">
                    <ul class="comments">
                        <li>
                            <span><span class="point-bold userID">postmalone</span>내가 입으면 더 잘어울릴 것 같아</span>
                            <div>
                                <img class="comment-more" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/more.png" alt="more">
                            </div>
                        </li>
                        <!-- input 값 여기에 추가 -->
                    </ul>
                    <div class="time-log">
                        <span class="point-span userID">댓글 더보기</span>
                    </div>
                </div>
            </div>
            <div class="hl"></div>
            <div class="comment">
                <input id="input-comment" class="input-comment" type="text" placeholder="댓글 달기..." >
                <button type="submit" class="" id="submit-comment" disabled>게시</button>
            </div>
        </article>
    </div>
    <!-- main-right -->
    <div class="main-right">
        <div class="myProfile">
            <img class="pic" src="https://item.kakaocdn.net/do/d84248170c2c52303db27306a00fb861f604e7b0e6900f9ac53a43965300eb9a" alt="프로필 사진">
            <div>
                <span class="userID point-bold" id="username-main">username</span>
                <span class="sub-span">Not yet!</span>
            </div>
        </div>
        <!-- alarm section -->
        <!-- story section -->
        <div class="section-story">
            <div class="menu-title">
                <span class="sub-title">알람</span>
                <span class="find-more">모두 보기</span>
            </div>
            <ul class="story-list" id="alarm-list">
<!--                <li>-->
<!--                    <div class="gradient-wrap">-->
<!--                        <img class="img-profile story" src="https://cdn-icons-png.flaticon.com/512/1230/1230203.png" alt="댓글알림">-->
<!--                    </div>-->
<!--                    <div class="profile-text">-->
<!--                        <span class="userID point-span" style="color: #262626">NEW_COMMENT_ON_POST</span>-->
<!--                        <span class="sub-span">28분 전</span>-->
<!--                    </div>-->
<!--                </li>-->
<!--                <li>-->
<!--                    <div class="gradient-wrap">-->
<!--                        <img class="img-profile story" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/heart.png" alt="좋아요알림">-->
<!--                    </div>-->
<!--                    <div class="profile-text">-->
<!--                        <span class="userID point-span">dntlrdl</span>-->
<!--                        <span class="sub-span">40분 전</span>-->
<!--                    </div>-->
<!--                </li>-->
            </ul>
        </div>
        <!-- recommendation section -->

        <footer>
            <p class="insta-sccript">
                <a href="/oauth2/authorization/google">소개</a>> ∙ 도움말 ∙ 홍보 센터 ∙ API ∙ 채용 정보 ∙ 개인정보처리방침 ∙ <br>약관 ∙ 위치 ∙ 인기계정 ∙ 해시태그 ∙ 언어
                <br><br>
                © 2020 INSTAGRAM FROM FACEBOOK
            </p>
        </footer>
    </div>
</main>

    <script>
        var loginUser = {
            token: null,
            userName: '유저 이름',
            userId: null,
            likeList: []
        }
        var nowPage = 0;

        $(document).ready(function () {
            if (boolCheckCookie('token')){      //로그인된 상태
                getMyInfo();
                likeListOfUser();
                showAlarm();
                let ob = document.getElementById('btn-logout');
                ob.classList.remove('hidden');

                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('login-id').classList.add('hidden');
                document.getElementById('login-pw').classList.add('hidden');
            }
            showPost(setMoreButton);
        });


        function showPost() {
            var param = '?page=' + nowPage;
            $.ajax({
                type: 'GET',
                url: '/api/v1/posts' + param,
                data: {},
                success: function (response) {
                    let posts = response['result']['content']
                    for (let i = 0; i < posts.length; i++) {
                        let id = posts[i]['id'];
                        let title = posts[i]['title'];
                        let body = posts[i]['body'];
                        let userName = posts[i]['userName'];

                        let temp_html = `
                               <!-- article -->
                                <article>
                                    <header>
                                        <div class="profile-of-article">
                                            <span style="display: none" class="post-id">${id}</span>
                                            <span class="userID point-span-title">${title}</span>
                                            <span class="userID main-id point-span">${userName}</span>
                                        </div>
                                        <img class="icon-react icon-more" src="https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/more.png" alt="more">
                                    </header>
                                    <div class="article-main">
                                        <div class="artice-body">
                                            ${body}
                                        </div>
                                    </div>
                                    <div class="icons-react">
                                    </div>
                                    <!-- article text data -->
                                    <div class="reaction">
                                        <div class="liked-people">
                                            <img class="icon-react" id="heart-icon-${id}" onclick="sendLike(${id})" src="img/heart_off.png" alt="하트">
                                            <p><span class="point-bold" id="like-num-${id}">2,412,751명</span>이 좋아합니다</p>
                                        </div>
                                        <div class="comment-section">
                                            <ul class="comments" id="comment-box-${id}">
                                                <!-- input 값 여기에 추가 -->
                                            </ul>
                                            <div class="time-log">
                                                <span class="point-span userID">댓글 더보기</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="hl"></div>
                                    <div class="comment">
                                        <input id="input-comment-${id}" class="input-comment" type="text" placeholder="댓글 달기..." >
                                        <button type="submit" class="submit-comment" onclick="sendComment(${id})">게시</button>
                                    </div>
                                </article>
                        `
                        $('#feeds-box').append(temp_html);
                        showComment(id);
                        showLikeNum(id);
                        heartToggle(id);
                    }
                    // var buttons = document.getElementsByClassName('btn-more');
                    // buttons.remove();
                    setMoreButton();
                }
            });
        }
        function setMoreButton(){
            let button_html = `
                           <button class="btn-more" type="button" onclick="clickMore()">
                                more
                           </button>`
            $('#feeds-box').append(button_html);
        }
        function showComment(postId){
            $.ajax({
                type: 'GET',
                url: '/api/v1/posts/' + postId + '/comments',
                data: {},
                success: function (response) {
                    let comments = response['result']['content']
                    for (let i = 0; i < comments.length; i++) {
                        let id = comments[i]['id'];
                        let comment = comments[i]['comment'];
                        let author = comments[i]['userName'];

                        let temp_html = `
                                 <li>
                                    <span><span class="point-bold userID">${author}</span>${comment}</span>
                                </li>
                        `
                        $('#comment-box-'+postId).append(temp_html);

                    }
                }
            });
        }
        function showLikeNum(postId){
            $.ajax({
                type: 'GET',
                url: '/api/v1/posts/' + postId + '/likes',
                data: {},
                success: function (response) {
                    var likeNum = response['result'];
                    $('#like-num-'+postId).text(likeNum+'명')
                }
            });
        }

        function sendComment(postId){
            let msg = $('#input-comment-'+postId).val();
            var sendData = {
                "comment":msg
            }

            $.ajax({
                contentType: "application/json; charset=utf-8",
                type: 'POST',
                url: '/api/v1/posts/'+postId+'/comments',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                dataType:'json',
                data: JSON.stringify(sendData),
                success: function(response) {
                    console.log(response)
                    alert(response['resultCode']);
                    window.location.reload();
                },
                error: function error(response){
                    alert(response.responseJSON.result.message);
                }
            })
        }
        function sendLike(postId){
            $.ajax({
                type: 'POST',
                url: '/api/v1/posts/'+postId+'/likes',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                success: function(response) {
                    console.log(response)
                    alert(response['resultCode']);
                    window.location.reload();
                },
                error: function error(response){
                    alert(response.responseJSON.result.message);
                }
            })
        }
        function getMyInfo(){
            $.ajax({
                type: 'GET',
                url: '/api/v1/users/my',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                success: function (response){
                    console.log(response['result']['userName']);
                    $('#username-main').text(response['result']['userName']);
                    $('#author-username').text(response['result']['userName']);

                }
            })
        }

        function likeListOfUser(){
            $.ajax({
                type: 'GET',
                url: '/api/v1/posts/likes/my',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                success: function (response){
                    console.log(response['result']);
                    loginUser.likeList = response['result'];
                }
            })
        }

        function heartToggle(postId){
            if(loginUser.likeList.includes(postId)){
                $('#heart-icon-'+postId).attr("src", "/img/heart_on.png");
            }
        }

        function clickMore(){
            let buttons = document.getElementsByClassName('btn-more');
            for(var i = 0; i < buttons.length; i++)
            {
                buttons[i].classList.add('hidden');
            }
            nowPage += 1;
            showPost(setMoreButton);
        }
        function writePost(){
            let title = $('#post-title-input').val();
            let body = $('#post-body-input').val();
            var sendData = {
                "title":title,
                "body":body
            }

            $.ajax({
                contentType: "application/json; charset=utf-8",
                type: "POST",
                url: "/api/v1/posts",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                dataType:'json',
                data: JSON.stringify(sendData),
                success: function(response) {
                    console.log(response)
                    alert(response['resultCode']);
                    window.location.reload();
                },
                error: function error(response){
                    alert(response.responseJSON.result.message);
                }
            })
        }
        function login() {
            let userName = $('#login-id').val();
            let password = $('#login-pw').val();
            var sendData = {
                "userName":userName,
                "password":password
            }
            $.ajax({
                contentType: "application/json; charset=utf-8",
                type: "POST",
                url: "/api/v1/users/login",
                dataType:'json',
                data: JSON.stringify(sendData),
                success: function(response) {
                    let token = response['result']['jwt'];
                    console.log(token);
                    alert(response['resultCode']);
                    setCookie('token', token, 60 * 60);
                    console.log(getCookie('token'));
                    window.location.reload();
                },
                error: function error(response){
                    alert(response.responseJSON.result.message);
                }
            })
        }
        function logout(){
            delCookie('token');
            window.location.reload();
        }
        //쿠키 저장
        // expiredays 는 일자 정수 - 365년 1년 쿠키
        function setCookie(key, value, expiredays) {
            let todayDate = new Date();
            todayDate.setDate(todayDate.getDate() + expiredays); // 현재 시각 + 일 단위로 쿠키 만료 날짜 변경
            //todayDate.setTime(todayDate.getTime() + (expiredays * 24 * 60 * 60 * 1000)); // 밀리세컨드 단위로 쿠키 만료 날짜 변경
            document.cookie = key + "=" + escape(value) + "; path=/; expires=" + todayDate.toGMTString() + ";";
        }
        // 쿠키 읽기
        function getCookie(key){
            key = new RegExp(key + '=([^;]*)'); // 쿠키들을 세미콘론으로 구분하는 정규표현식 정의
            return key.test(document.cookie) ? unescape(RegExp.$1) : ''; // 인자로 받은 키에 해당하는 키가 있으면 값을 반환
        }
        //쿠키 체크 - 있으면 true 없으면 false
        //getCookie() 에 의존
        function boolCheckCookie(key) {
            return getCookie(key) != '' ? true : false;
        }
        //쿠키 삭제
        //쿠키는 삭제가 없어서 현재 시각으로 만료 처리를 함.
        function delCookie(key){
            let todayDate = new Date();
            document.cookie = key + "=; path=/; expires=" + todayDate.toGMTString() + ";" // 현재 시각 이전이면 쿠키가 만료되어 사라짐.
        }
        function showAlarm(){
            $.ajax({
                type: 'GET',
                url: '/api/v1/alarms',
                data: {},
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Content-type","application/json");
                    xhr.setRequestHeader("Authorization","Bearer " + getCookie('token'));
                },
                success: function (response) {
                    let alarms = response['result']['content']
                    console.log(alarms);
                    for (let i = 0; i < alarms.length; i++) {
                        let alarmType = alarms[i]['alarmType'];
                        let createdAt = alarms[i]['createdAt'];
                        let targetId = alarms[i]['targetId'];
                        let text = alarms[i]['text'];

                        let src;
                        if(alarmType === 'NEW_COMMENT_ON_POST'){
                            src = "https://cdn-icons-png.flaticon.com/512/1230/1230203.png";
                        } else{
                            src = "https://s3.ap-northeast-2.amazonaws.com/cdn.wecode.co.kr/bearu/heart.png";
                        }

                        let temp_html = `
                                <li>
                                    <div class="gradient-wrap">
                                        <img class="img-profile story" src="${src}" alt="알림아이콘">
                                    </div>
                                    <div class="profile-text">
                                        <span class="userID point-span" style="color: #262626">${text}</span>
                                        <span class="sub-span">${createdAt}</span>
                                    </div>
                                </li>
                        `
                        $('#alarm-list').append(temp_html);
                    }
                }
            });
        }


    </script>
</body>
</html>